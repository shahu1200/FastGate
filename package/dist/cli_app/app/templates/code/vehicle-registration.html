{% extends "base.html" %}

{% block content %} 

  <!--header end-->

    <!--form start-->
<script>

function UploadProcess() {
        //Reference the FileUpload element.
        var fileUpload = document.getElementById("fileUpload");
 
        //Validate whether File is valid Excel file.
        var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.xls|.xlsx)$/;
        alert("Wait for adding excel file!");
        if (regex.test(fileUpload.value.toLowerCase())) {
            if (typeof (FileReader) != "undefined") {
                var reader = new FileReader();
 
                //For Browsers other than IE.
                if (reader.readAsBinaryString) {
                    reader.onload = function (e) {
                        GetTableFromExcel(e.target.result);
                    };
                    reader.readAsBinaryString(fileUpload.files[0]);
                } else {
                    //For IE Browser.
                    reader.onload = function (e) {
                        var data = "";
                        var bytes = new Uint8Array(e.target.result);
                        for (var i = 0; i < bytes.byteLength; i++) {
                            data += String.fromCharCode(bytes[i]);
                        }
                        GetTableFromExcel(data);
                    };
                    reader.readAsArrayBuffer(fileUpload.files[0]);
                }
            } else {
                alert("This browser does not support HTML5.");
            }
        } else {
            alert("Please upload a valid Excel file.");
        }
    };

    function GetTableFromExcel(data) {
        //Read the Excel File data in binary
        var vehiclelist = [];
        var workbook = XLSX.read(data, {
            type: 'binary'
        });
 
        //get the name of First Sheet.
        var Sheet = workbook.SheetNames[0];
 
        //Read all rows from First Sheet into an JSON array.
        var excelRows = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[Sheet]);
 
        //Create a HTML Table element.
        
        //Add the data rows from Excel file.
        var data_frame = {};
        for (var i = 0; i < excelRows.length; i++) {
            //Add the data row.
            console.log(excelRows[i]);
            data_frame = {};
            data_frame["tagId"] = excelRows[i]["TAG ID"];
            data_frame["ownerName"] = excelRows[i]["OWNER NAME"];
            data_frame["vehicleNo"] = excelRows[i]["VEHICLE NO"];
            data_frame["flatNo"] = excelRows[i]["FLAT NO"];
            data_frame["fromDate"] = excelRows[i]["FROM DATE"];
            data_frame["toDate"] = excelRows[i]["TO DATE"];
            data_frame["toTime"] = excelRows[i]["FROM TIME"];
            data_frame["weekDay"] = excelRows[i]["WEEK DAY"];
            data_frame["blkFromDate"] = excelRows[i]["BLOCK FROM DATE"];
            data_frame["blkToDate"] = excelRows[i]["BLOCK TO DATE"];
            data_frame["blkToTime"] = excelRows[i]["BLOCK FROM TIME"];
            data_frame["blkWeekDay"] = excelRows[i]["BLOCK WEEK DAY"];
            data_frame["auth"] = excelRows[i]["AUTHORITY"];
            vehiclelist.push(data_frame);
        }
        var formdict = {};
        formdict["userlist"] = vehiclelist;
        console.log(formdict);
      fetch("/api/vehicle_registration",{
        method: "POST",
        body: JSON.stringify(formdict),
        headers: {
          'Content-Type': 'application/json'
      }
      }).then(function (response) {
      if (response.status !== 200) {
        console.log(`Looks like there was a problem. Status code: ${response.status}`);
        return;
      }
      response.json().then(function (data) {
        console.log(data);
        alert("Successfully added User Vehicle!");
      });
    })
    };

function myFunction() {
var formdatas = ($('input').serializeArray());
var formdict = {};
var formdict1 = {};
var userlist = [];
console.log(formdatas); 
$.each(formdatas, function(i, n){
  formdict[n['name']] = n['value'];
});

formdict1["userlist"] = userlist.push(formdict);
fetch("/api/vehicle_registration",{
    method: "POST",
    body: JSON.stringify(formdict1),
    headers: {
      'Content-Type': 'application/json'
  }
}).then(function (response) {
      if (response.status !== 200) {
        console.log(`Looks like there was a problem. Status code: ${response.status}`);
        return;
      }
      response.json().then(function (data) {
        console.log(data);
        alert("Successfully added User Vehicle!");
      });
    })
}
</script>

    <div class="global-container">
      <div class="card login-form">
      <div class="card-body">
        <h3 class="card-title text-center">Vehicle Registration</h3>
        <div class="card-text">
          <!--
          <div class="alert alert-danger alert-dismissible fade show" role="alert">Incorrect username or password.</div> -->
            
            <!-- to error: add class "has-danger" -->
            <div class="form-group">
              <label for="exampleInputEmail1" style="font-weight: 600;">Tag ID</label>
              <input type="text" name="tagId" class="form-control form-control-sm" id="exampleInputEmail1" aria-describedby="emailHelp">
              <a href="https://www.npci.org.in/what-we-do/netc-fastag/check-your-netc-fastag-status" target="_blank" style="float:right;font-size:12px;">NPCI Link</a>
            </div>
            <div class="form-group">
              <label for="exampleInputPassword1" style="font-weight: 600;">Vehicle No</label>
              
              <input type="text" name="VEHICLE_NO" class="form-control form-control-sm" id="exampleInputPassword1">
              
            </div>
            <div class="form-group">
                <label for="exampleInputPassword1" style="font-weight: 600;">Owner Name</label>
                
              <input type="text" name="OWNER_NAME" class="form-control form-control-sm" id="exampleInputPassword1">
                
              </div> 
              <div class="form-group">
                <label for="exampleInputPassword1" style="font-weight: 600;">Flat No</label>
                
                <input type="text" name="FLAT_NO" class="form-control form-control-sm" id="exampleInputPassword1">
                
              </div><br>
            <button type="submit" class="btn btn-warning btn-block" style="font-weight: 600;" onclick="myFunction()">Save</button>
            <button type="submit" class="btn btn-light btn-block">Cancel</button>
            <br>
            <input type="file" id="fileUpload" />
            <input type="button" class="btn btn-warning btn-block" id="upload" value="Upload" onclick="UploadProcess()" />
            <br/>
        </div>
      </div>
        
    </div>
        
    </div>
    <script src="{{ url_for('static',filename='js/xlsx.full.min.js') }}"></script>
    <script src="{{ url_for('static',filename='js/jszip.js') }}"></script>
    {% endblock %}