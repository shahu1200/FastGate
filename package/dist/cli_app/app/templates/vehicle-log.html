{% extends "base.html" %}

{% block content %}

  <!--header end-->

    <!--form start-->
<script>

function htmlToCSV(html, filename) {
	var data = [];
  var heads = document.querySelectorAll("table thead tr");
	var rows = document.querySelectorAll("table tbody tr");

  for (var i = 0; i < heads.length; i++) {
		var row = [], cols = heads[i].querySelectorAll("td, th");
				
		for (var j = 0; j < cols.length; j++) {
		        row.push(cols[j].innerText);
        }
		        
		data.push(row.join(",")); 		
	}
			
	for (var i = 0; i < rows.length; i++) {
		var row = [], cols = rows[i].querySelectorAll("td, th");
				
		for (var j = 0; j < cols.length; j++) {
		        row.push(cols[j].innerText);
        }
		        
		data.push(row.join(",")); 		
	}
	downloadCSVFile(data.join("\n"), filename);
}

function downloadCSVFile(csv, filename) {
	var csv_file, download_link;

	csv_file = new Blob([csv], {type: "text/csv"});

	download_link = document.createElement("a");

	download_link.download = filename;

	download_link.href = window.URL.createObjectURL(csv_file);

	download_link.style.display = "none";

	document.body.appendChild(download_link);

	download_link.click();
}

function pressDownload()
{
  console.log("download clicked");
	var html = document.querySelector("table").outerHTML;
	htmlToCSV(html, "vehiclelogs.csv");
}

function myFunction(event) {

  var fromdatel = dateformats($('input[name=fromdate]').val());
  var todatel = dateformats($('input[name=todate]').val());
  var formdatas = {
    'antName': $('select[name=antName]').val(),
    'fromdate': fromdatel,
    'todate': todatel
  };
  console.log(formdatas); 
  
  fetch("/api/get_vehicle_logs",{
      method: "POST",
      body: JSON.stringify(formdatas),
      headers: {
        'Content-Type': 'application/json'
    }
  }).then(function (response) {
        if (response.status !== 200) {
          console.log(`Looks like there was a problem. Status code: ${response.status}`);
          return;
        }
        response.json().then(function (data) {
          console.log(data);
          var trHTML = '';
          $('#vehiclelogtb').empty();

          $.each(data, function (i, item) {
            trHTML += '<tr><td>' + (parseInt(i)+1) + '</td><td>' + item[1] + '</td><td>' + item[2] + '</td><td>' + item[3] + '</td><td>' + item[4] + '</td></tr>';
          });
          $('#vehiclelogtb').append(trHTML);
        });
      })
}

</script>


    <div class="global-container">
      <div class="card vehiclelog-form">
      <div class="card-body">
        <h3 class="card-title text-center">Vehicle Log</h3> <hr>
        <div class="card-text">
          <!--
          <div class="alert alert-danger alert-dismissible fade show" role="alert">Incorrect username or password.</div> -->
          <form>
            <div class="form-row align-items-center">
              <div class="col-md-4 my-1">
                <label for="exampleInputPassword1" style="font-weight: 600;">From Date</label>
              
              <input type="date" name="fromdate" value="0000-00-00" format="dd-mm-yyyy" class="form-control form-control-sm" id="exampleInputPassword1" onchange="myFunction()">
              </div>
              <div class="col-md-4 my-1">
                <label for="exampleInputPassword1" style="font-weight: 600;">To Date</label>
              
              <input type="date" name="todate" class="form-control form-control-sm" id="exampleInputPassword1" onchange="myFunction(event)">
              </div>
              <div class="col-md-4 my-1">
                <label for="exampleInputPassword1" style="font-weight: 600;">Gate</label>
                <select id="inputState" class="form-control" name="antName" onchange="myFunction(event)">
                  <option selected value="Select All">Select All</option>
                  {% for name in data["antennas"] %}
                    {% if name != "NA" %}
                      <option>{{name}}</option>
                    {% endif %}
                  {% endfor %}
                </select>
               </div>
            </div>
          </form> <br> <br>
          <!--table start-->
          <div class="table-responsive" style="max-height: 250px;overflow-y: scroll; ">
          <table class="table table-striped "   style="text-align: center;">
            <thead>
              <tr > 
                <th scope="col" >Sr. No</th>
                <th scope="col" >Tag ID</th>
                <!-- <th scope="col" >Transaction Type</th> -->
                <th scope="col" >Date - Time</th>
                <th scope="col" >Gate</th>
                <th scope="col" >Transaction Type</th>                
              </tr>
            </thead>
            <tbody id="vehiclelogtb" style="height:100px;" >
              
            </tbody>
          </table>          
        </div>
        
        </div>
        <button id="download-button" type="submit" class="btn btn-warning btn-block" style="font-weight: 600;" onclick="pressDownload()">Download CSV</button>
      </div>
    </div>
    </div>
    
   <!--form end--> 
   {% endblock %}