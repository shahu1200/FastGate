{% extends "base.html" %}

{% block content %}
<script>

  function deleteUserVehicle()
  {
    var taglist = [];
    var formdict = {};
    var tagdict = $("input[name=chek]").serializeArray();
    console.log(tagdict);
    if (confirm("Are you sure to delete vehicle users?") == true) {
         x = 1;
     } else {
         x = 0;
     }

    if (x == 1)
    {
      console.log("call for delete");
      $.each(tagdict, function(i, n){
        taglist.push(n['value']);
      })
      formdict["taglist"] = taglist;
      fetch("/api/delete_vehicleUser",{
      method: "POST",
      body: JSON.stringify(formdict),
      headers: {
        'Content-Type': 'application/json'
      }
      }).then(function (response) {
          if (response.status !== 200) {
            console.log(`Looks like there was a problem. Status code: ${response.status}`);
            return;
          }
          response.json().then(function (data) {
            console.log(data);
            alert("Successfully Deleted all Selected Users!");
            location.reload();
          });
        })
    }
  }

  function htmlToCSV(html, filename) {
	var data = [];
	var heads = document.querySelectorAll("table thead tr");
	var rows = document.querySelectorAll("table tbody tr");

  for (var i = 0; i < heads.length; i++) {
		var row = [], cols = heads[i].querySelectorAll("td, th");
				
		for (var j = 1; j < cols.length; j++) {
		        row.push(cols[j].innerText);
        }
		        
		data.push(row.join(",")); 		
	}
			
	for (var i = 0; i < rows.length; i++) {
		var row = [], cols = rows[i].querySelectorAll("td, th");
				
		for (var j = 1; j < cols.length; j++) {
		        row.push(cols[j].innerText);
        }
		        
		data.push(row.join(",")); 		
	}
	downloadCSVFile(data.join("\n"), filename);
}

function downloadCSVFile(csv, filename) {
	var csv_file, download_link;

	csv_file = new Blob([csv], {type: "text/csv"});

	download_link = document.createElement("a");

	download_link.download = filename;

	download_link.href = window.URL.createObjectURL(csv_file);

	download_link.style.display = "none";

	document.body.appendChild(download_link);

	download_link.click();
}

function pressDownload()
{
  console.log("download clicked");
	var html = document.querySelector("table").outerHTML;
	htmlToCSV(html, "uservehicles.csv");
}
</script>
    <div class="global-container">
      <div class="card vehiclelog-form">
      <div class="card-body">
        <h3 class="card-title text-center">User Vehicles</h3> <hr>
        <div class="card-text">
          <!--table start-->
          <div class="table-responsive" style="max-height: 400px;overflow-y: scroll;">
          <table class="table table-striped" style="text-align: center;">
            <thead >
              <tr>
                <th scope="col"></th>
                <th scope="col">Sr. No</th>
                <th scope="col">Tag ID</th>
                <th scope="col">Owner Name</th>
                <th scope="col">Date - Time</th>
                <th scope="col">Flat No</th>
                <th scope="col">Vehicle No</th>
                <th scope="col">Access Start Date</th>
                <th scope="col">Access End Date</th>
                <th scope="col">Access Start Time</th>
                <th scope="col">Access End Time</th>
                <th scope="col">Access Week Days</th>
                <th scope="col">Block Start Date</th>
                <th scope="col">Block End Date</th>
                <th scope="col">Block Start Time</th>
                <th scope="col">Block End Time</th>
                <th scope="col">Block Week Days</th>
                <th scope="col">Authority</th>
              </tr>
            </thead>
            <tbody id="vehiclelogtb">
                {% for vehicle in data["uservehicles"] %}
                <tr>
                    <td><input type="checkbox" name="chek" value='{{vehicle[1]}}'></td>
                    <td>{{loop.index}}</td>
                    <td>{{vehicle[1]}}</td>
                    <td>{{vehicle[2]}}</td>
                    <td>{{vehicle[3]}}</td>
                    <td>{{vehicle[4]}}</td>
                    <td>{{vehicle[5]}}</td>
                    <td>{{vehicle[6]}}</td>
                    <td>{{vehicle[7]}}</td>
                    <td>{{vehicle[8]}}</td>
                    <td>{{vehicle[9]}}</td>
                    <td>{{vehicle[10]}}</td>
                    <td>{{vehicle[11]}}</td>
                    <td>{{vehicle[12]}}</td>
                    <td>{{vehicle[13]}}</td>
                    <td>{{vehicle[14]}}</td>
                    <td>{{vehicle[15]}}</td>
                    <td>{{vehicle[16]}}</td>
                    </tr>
                {% endfor %}
            </tbody>
          </table>
        </div>
          {% if data["authority"] == 1 or data["authority"] == 2 %}
            <button id="delete" type="submit" class="btn btn-danger btn-block" style="font-weight: 600;" onclick="deleteUserVehicle()">Delete</button>
          {% endif %}
        </div>
        <button id="download-button" type="submit" class="btn btn-warning btn-block" style="font-weight: 600;" onclick="pressDownload()">Download CSV</button>
      </div>
    </div>
    </div>
    
   <!--form end--> 
   {% endblock %}